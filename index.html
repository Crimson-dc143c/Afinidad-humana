<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afinidad Humana V9.1 ‚Äî Cloud Sync</title>
    
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS BASE --- */
        :root {
            --bg: #090c10; --panel: #161b22; --border: #30363d;
            --text-main: #c9d1d9; --text-muted: #8b949e;
            --accent: #58a6ff; --danger: #f85149; --success: #238636; --gold: #d29922;
            --ai-color: #a371f7;
            --cat-val: #d2a8ff; --cat-goal: #7ee787; --cat-int: #79c0ff; --cat-trait: #f0883e; --cat-extra: #8b949e;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        * { scrollbar-width: thin; scrollbar-color: #58a6ff #0d1117; box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }

        /* Sidebar Layout */
        #sidebar-container {
            width: 420px; background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: row; z-index: 20; box-shadow: 4px 0 20px rgba(0,0,0,0.5);
            height: 100vh; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; flex-shrink: 0;
        }
        #sidebar-container.collapsed { width: 0; border: none; }
        #sidebar-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0px; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); background: var(--panel); flex-shrink: 0; z-index: 10; }
        #sidebar-ui { overflow-y: auto; overflow-x: hidden; height: 100%; padding: 20px; }

        #sidebar-toggle {
            position: absolute; top: 50%; right: -24px; width: 24px; height: 48px;
            background: var(--panel); border: 1px solid var(--border); border-left: none;
            border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); z-index: 25; transition: 0.3s; box-shadow: 4px 0 10px rgba(0,0,0,0.2); user-select: none;
        }
        #sidebar-toggle:hover { color: var(--accent); background: #1f262e; }
        #sidebar-container.collapsed #sidebar-toggle { right: -24px; }

        /* Componentes UI */
        h2 { margin: 0; font-weight: 600; color: white; letter-spacing: -0.5px; }
        h3 { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        input, textarea, select { background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; margin-bottom: 8px; outline: none; font-size: 0.9rem; transition: border-color 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent); }
        .btn { background: var(--panel); border: 1px solid var(--border); color: var(--text-main); padding: 8px 12px; border-radius: 6px; cursor: pointer; width: 100%; transition: 0.2s; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap:5px;}
        .btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(88, 166, 255, 0.1); }
        .btn-primary { background: var(--accent); color: #090c10; border: none; font-weight: 700; }
        .btn-danger { color: var(--danger); border-color: var(--border); }
        .btn-ai { background: rgba(163, 113, 247, 0.1); border-color: var(--ai-color); color: var(--ai-color); }
        .btn-ai:hover { background: var(--ai-color); color: white; }
        
        /* Boton Login */
        .btn-google { background: #fff; color: #333; font-weight: bold; border: none; }
        .btn-google:hover { background: #eee; }

        /* Listas y Tags */
        .person-row { display: flex; align-items: center; padding: 8px; border-radius: 6px; margin-bottom: 4px; transition: background 0.2s; }
        .person-row:hover { background: rgba(255,255,255,0.03); }
        .person-check { margin-right: 10px; accent-color: var(--accent); cursor: pointer; width: 16px; height: 16px; }
        .person-info { flex-grow: 1; cursor: pointer; display: flex; justify-content: space-between; }

        details { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        summary { padding: 12px 15px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; justify-content: space-between; list-style: none; }
        summary:after { content: '+'; font-size: 1.2rem; color: var(--text-muted); transition: 0.2s; }
        details[open] summary:after { content: '-'; color: var(--accent); transform: rotate(180deg); }
        .details-content { padding: 15px; border-top: 1px solid var(--border); }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-item { font-size: 0.8rem; padding: 6px 14px; border-radius: 20px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.15); color: #e6edf3; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; position: relative; overflow: hidden; }
        .tag-item:hover { background: rgba(255,255,255,0.08); padding-right: 34px; }
        .tag-item.active { font-weight: 700; background: rgba(212,244,255,0.04); border-color: transparent; color: #050505 !important; transform: scale(1.02); }
        .tag-item.active.cat-values { background-color: var(--cat-val); }
        .tag-item.active.cat-aspirations { background-color: var(--cat-goal); }
        .tag-item.active.cat-interests { background-color: var(--cat-int); }
        .tag-item.active.cat-traits { background-color: var(--cat-trait); }
        .tag-item.active.cat-extras { background-color: var(--cat-extra); }
        .tag-item.local { border-style: dashed; opacity: 0.95; }
        .tag-del-btn { position: absolute; right: 6px; top: 50%; transform: translateY(-50%) scale(0.5); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); color: inherit; font-size: 10px; opacity: 0; transition: 0.2s; pointer-events: none; }
        .tag-item:hover .tag-del-btn { opacity: 1; transform: translateY(-50%) scale(1); pointer-events: auto; }
        .promote-btn { width: 16px; height: 16px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 10px; color: inherit; transition: 0.2s; }
        .promote-btn:hover { background: #fff; color: #000; }

        /* Notas Editables */
        #canvas-notes-panel { position: absolute; top: 20px; right: 20px; bottom: 20px; width: 320px; z-index: 40; display: none; flex-direction: column; gap: 10px; overflow-y: auto; padding-right: 5px; pointer-events: none; }
        .note-card { pointer-events: auto; padding: 12px 15px; border-radius: 8px; position: relative; font-size: 0.9rem; border-left: 5px solid; color: #090c10; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(4px); word-wrap: break-word; transition: transform 0.2s; }
        .note-card:hover { transform: scale(1.02); }
        .note-date { font-size: 0.7rem; opacity: 0.7; display: block; margin-bottom: 6px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 4px; }
        .note-content[contenteditable="true"] { outline: 2px solid rgba(0,0,0,0.2); background: rgba(255,255,255,0.4); padding: 5px; border-radius: 4px; }
        .note-card.yellow { background: rgba(255, 249, 196, 0.95); border-color: #fbc02d; }
        .note-card.red { background: rgba(255, 205, 210, 0.95); border-color: #e53935; }
        .note-card.green { background: rgba(200, 230, 201, 0.95); border-color: #43a047; }
        .note-card.blue { background: rgba(187, 222, 251, 0.95); border-color: #1e88e5; }
        .note-actions { position: absolute; top: 8px; right: 8px; opacity: 0; transition: 0.2s; display: flex; gap: 5px; }
        .note-card:hover .note-actions { opacity: 1; }
        .mini-btn { border: none; background: rgba(0,0,0,0.1); border-radius:4px; cursor: pointer; font-size: 0.8rem; padding: 4px 6px; color:#333; }
        .mini-btn:hover { background: rgba(0,0,0,0.2); }

        /* Rich Editor & IA */
        .editor-container { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; margin-bottom: 10px; background: #0d1117; }
        .editor-toolbar { display: flex; gap: 5px; padding: 5px; background: #161b22; border-bottom: 1px solid var(--border); }
        .editor-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .editor-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        #rich-editor { min-height: 80px; padding: 10px; color: white; outline: none; font-size: 0.9rem; line-height: 1.5; }
        
        .ai-panel { background: linear-gradient(135deg, rgba(163, 113, 247, 0.05) 0%, rgba(22, 27, 34, 0) 100%); border: 1px solid rgba(163, 113, 247, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .ai-response { font-size: 0.85rem; color: #d0d7de; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 10px; display: none; white-space: pre-wrap; border-left: 3px solid var(--ai-color); }

        /* Espejo */
        .comp-row { display: flex; margin-bottom: 8px; font-size: 0.85rem; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px;}
        .comp-col { flex: 1; padding: 5px; }
        .comp-col.shared { color: var(--cat-goal); }
        .comp-col.diff { color: var(--danger); text-align: right; }
        .circle-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .circle-green { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .circle-red { background: var(--danger); box-shadow: 0 0 5px var(--danger); }

        /* Canvas & Top Bar */
        #top-mode-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(22, 27, 34, 0.9); padding: 8px 20px; border-radius: 30px; border: 1px solid var(--border); display: flex; gap: 15px; z-index: 50; box-shadow: 0 5px 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px); align-items: center; }
        .mode-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-weight: 600; padding: 5px 10px; border-radius: 15px; transition: 0.2s; font-size: 0.9rem; }
        .mode-btn.active { background: var(--accent); color: #090c10; box-shadow: 0 0 10px var(--accent); }
        #main-canvas { flex-grow: 1; position: relative; background: radial-gradient(circle at center, #1c2128 0%, #090c10 100%); overflow: hidden; }
        
        #settings-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; display:none; align-items:center; justify-content:center; }
        .modal-box { background: var(--panel); padding: 25px; border-radius: 10px; border: 1px solid var(--border); width: 400px; max-width: 90%; }
        
        /* Auth Overlay */
        #auth-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(9, 12, 16, 0.9); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <h1 style="color:white; margin-bottom:10px;">Afinidad Humana V9</h1>
        <p style="color:var(--text-muted); margin-bottom:30px;">Cargando sistema...</p>
    </div>

    <div id="sidebar-container">
        <div id="sidebar-content">
            <div class="sidebar-header" id="sidebar-header-content"></div>
            <div id="sidebar-ui"></div>
        </div>
        <div id="sidebar-toggle" onclick="App.toggleSidebar()">‚óÄ</div>
    </div>

    <div id="top-mode-bar">
        <button class="mode-btn active" id="btn-radial" onclick="App.setMacroView('radial')"> ò Universo</button>
        <button class="mode-btn" id="btn-mesh" onclick="App.setMacroView('mesh')">‚òä Red Social</button>
        <div style="width: 1px; height: 20px; background: var(--border);"></div>
        <button class="mode-btn" onclick="App.openSettings()">‚öôÔ∏è IA</button>
        <button class="mode-btn" id="btn-login" onclick="App.login()" style="display:none; color: var(--accent);">G Login</button>
        <div id="user-display" style="display:none; align-items:center; gap:10px;">
             <img id="user-pic" src="" style="width:24px; height:24px; border-radius:50%; border:1px solid var(--border);">
             <button class="mode-btn" onclick="App.logout()" style="font-size:0.8rem; color:var(--danger)">Salir</button>
        </div>
    </div>

    <div id="main-canvas">
        <div id="mynetwork" style="width: 100%; height: 100%;"></div>
        <div id="canvas-notes-panel"></div>
    </div>

    <div id="settings-modal">
        <div class="modal-box">
            <h2>‚öôÔ∏è Configuraci√≥n IA</h2>
            <p style="font-size:0.85rem; color:var(--text-muted); line-height:1.4;">Ingresa tu API Key de OpenAI para habilitar funciones inteligentes.</p>
            <input type="password" id="api-key-input" placeholder="sk-..." style="margin-top:15px;">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" onclick="App.saveSettings()">Guardar</button>
                <button class="btn" onclick="document.getElementById('settings-modal').style.display='none'">Cancelar</button>
            </div>
        </div>
    </div>

<script>
// --- FIREBASE CONFIG ACTUALIZADO ---
const firebaseConfig = {
  apiKey: "AIzaSyDkEd8nS_B9bh-hLJxbc30Sb84IzFpB6YA",
  authDomain: "afinidad-humana.firebaseapp.com",
  projectId: "afinidad-humana",
  storageBucket: "afinidad-humana.firebasestorage.app",
  messagingSenderId: "554727868325",
  appId: "1:554727868325:web:c3b9e259b0710d37134a4c",
  measurementId: "G-NRKNBR00JC"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const App = {
    // --- STATE ---
    data: {
        me: { id: 'me', name: 'YO', categories: { values:[], interests:[], traits:[], aspirations:[], extras:[] }, notes: [] },
        people: [], apiKey: "", settings: { selectedForNetwork: [] },
library: [
            // Valores
            { id: 'v1', label: 'Honestidad', category: 'values' }, 
            { id: 'v2', label: 'Lealtad', category: 'values' },
            { id: 'v3', label: 'Respeto', category: 'values' }, 
            { id: 'v4', label: 'Compasi√≥n', category: 'values' },
            { id: 'v5', label: 'Perseverancia', category: 'values' }, 
            { id: 'v6', label: 'Independencia', category: 'values' },
            { id: 'v7', label: 'Tolerancia', category: 'values' }, 
            // Aspiraciones (Metas)
            { id: 'm1', label: 'Emprender', category: 'aspirations' },
            { id: 'm2', label: 'Salud f√≠sica', category: 'aspirations' },
            { id: 'm3', label: 'Salud mental', category: 'aspirations' },
            { id: 'm4', label: 'Desarrollo personal', category: 'aspirations' },
            { id: 'm5', label: 'Crecimiento profesional', category: 'aspirations' },
            { id: 'm6', label: 'Familia', category: 'aspirations' },
            { id: 'm7', label: 'Amor', category: 'aspirations' },
            // Intereses
            { id: 'i1', label: 'M√∫sica', category: 'interests' },
            { id: 'i2', label: 'Gimnasio', category: 'interests' },
            { id: 'i3', label: 'Baile', category: 'interests' },
            { id: 'i4', label: 'Cine', category: 'interests' },
            { id: 'i5', label: 'Lectura', category: 'interests' },
            { id: 'i6', label: 'Escritura', category: 'interests' },
            { id: 'i7', label: 'Arte', category: 'interests' },
            { id: 'i8', label: 'Deporte', category: 'interests' },
            { id: 'i9', label: 'Tecnolog√≠a', category: 'interests' },
            // Rasgos
            { id: 't1', label: 'Anal√≠tico', category: 'traits' },
            { id: 't2', label: 'Creativo', category: 'traits' },
            { id: 't3', label: 'Reflexivo', category: 'traits' },
            { id: 't4', label: 'Sensible', category: 'traits' },
            { id: 't5', label: 'Competitivo', category: 'traits' },
            { id: 't6', label: 'So√±ador', category: 'traits' },
            { id: 't7', label: 'Directo', category: 'traits' },
            { id: 't8', label: 'Diplom√°tico', category: 'traits' },
            { id: 't9', label: 'Tranquilo', category: 'traits' },
            { id: 't10', label: 'Reservado', category: 'traits' },
            { id: 't11', label: 'Energ√©tico', category: 'traits' },
            { id: 't12', label: 'Adaptable', category: 'traits' },
            { id: 't13', label: 'Responsable', category: 'traits' },
            { id: 't14', label: 'Desordenado', category: 'traits' },
            { id: 't15', label: 'Perfeccionista', category: 'traits' },
            { id: 't16', label: 'Colaborador', category: 'traits' },
            { id: 't17', label: 'Puntual', category: 'traits' },
            // Extra
            { id: 'e1', label: 'Perro', category: 'extras' },
            { id: 'e2', label: 'Gato', category: 'extras' },
            { id: 'e3', label: 'Dulce', category: 'extras' },
            { id: 'e4', label: 'Salado', category: 'extras' },
            { id: 'e5', label: 'Playa', category: 'extras' },
            { id: 'e6', label: 'Monta√±a', category: 'extras' },
            { id: 'e7', label: 'Madruga', category: 'extras' },
            { id: 'e8', label: 'Trasnocha', category: 'extras' },
            { id: 'e7', label: 'Introvertido', category: 'extras' },
            { id: 'e8', label: 'Extrovertido', category: 'extras' },
        ],
        
        catConfigs: [
            { key: 'values', label: 'üíú Valores', weight: 3.0, color: '#d2a8ff', cssClass: 'cat-values' },
            { key: 'aspirations', label: 'üíö Metas', weight: 2.0, color: '#7ee787', cssClass: 'cat-aspirations' },
            { key: 'interests', label: 'üíô Gustos', weight: 2.0, color: '#79c0ff', cssClass: 'cat-interests' },
            { key: 'traits', label: 'üß° Rasgos', weight: 1.5, color: '#f0883e', cssClass: 'cat-traits' },
            { key: 'extras', label: 'üìì Extras', weight: 1.0, color: '#8b949e', cssClass: 'cat-extras' }
        ]
    },
    user: null, // Current Firebase User
    dbUnsubscribe: null, // Listener cancel function
    view: 'MACRO', macroMode: 'radial', activePersonId: null, network: null, nodes: new vis.DataSet([]), edges: new vis.DataSet([]), tempNoteColor: 'yellow', saveTimeout: null,

    init() {
        this.initNetwork();
        
        // Auth Listener
        auth.onAuthStateChanged(user => {
            this.user = user;
            const overlay = document.getElementById('auth-overlay');
            
            if (user) {
                // User Logged In
                document.getElementById('btn-login').style.display = 'none';
                document.getElementById('user-display').style.display = 'flex';
                document.getElementById('user-pic').src = user.photoURL || '';
                
                overlay.innerHTML = `<h1 style="color:white;">Sincronizando...</h1>`;
                this.loadFromFirebase();
            } else {
                // User Logged Out (Show local data or blank)
                document.getElementById('btn-login').style.display = 'block';
                document.getElementById('user-display').style.display = 'none';
                
                // Opci√≥n: Cargar local si no hay usuario, o forzar login
                overlay.style.display = 'none'; 
                this.loadLocalData(); // Fallback to local
                this.renderMacro();
            }
        });
    },

    // --- FIREBASE LOGIC ---
    login() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => alert("Error login: " + err.message));
    },

    logout() {
        if(this.dbUnsubscribe) this.dbUnsubscribe(); // Stop listening
        auth.signOut();
        location.reload();
    },

    loadFromFirebase() {
        if (!this.user) return;
        
        const docRef = db.collection('users').doc(this.user.uid);
        
        // Realtime Listener
        this.dbUnsubscribe = docRef.onSnapshot(doc => {
            const overlay = document.getElementById('auth-overlay');
            if (doc.exists) {
                const cloudData = doc.data();
                this.data = { ...this.data, ...cloudData }; // Merge structure
                console.log("‚òÅÔ∏è Datos sincronizados desde la nube");
                overlay.style.display = 'none';
                
                // Restore View State
                if (this.view === 'MACRO') this.renderMacro();
                else if (this.view === 'MICRO') this.enterMicro(this.activePersonId);
            } else {
                // No cloud data yet -> Upload Local Data if exists
                console.log("‚òÅÔ∏è Nube vac√≠a. Subiendo datos locales...");
                this.loadLocalData(); // Get local
                this.saveData(true); // Force push to cloud
                overlay.style.display = 'none';
                this.renderMacro();
            }
        }, err => {
            console.error(err);
            alert("Error de conexi√≥n con la base de datos");
            document.getElementById('auth-overlay').style.display = 'none';
        });
    },

    saveData(force = false) { 
        // 1. Save Local (Backup)
        localStorage.setItem('ah_v8_7', JSON.stringify(this.data)); 
        
        // 2. Save Cloud (Debounced)
        if (this.user) {
            if (this.saveTimeout) clearTimeout(this.saveTimeout);
            
            const doSave = () => {
                db.collection('users').doc(this.user.uid).set(JSON.parse(JSON.stringify(this.data)))
                .then(() => console.log("‚òÅÔ∏è Guardado en Firebase"))
                .catch(e => console.error("Error guardando:", e));
            };

            if(force) doSave();
            else this.saveTimeout = setTimeout(doSave, 1000); // Espera 1 seg de inactividad
        }
    },

    loadLocalData() {
        const saved = localStorage.getItem('ah_v8_7') || localStorage.getItem('ah_v8_6');
        if (saved) {
            try {
                const local = JSON.parse(saved);
                this.data = { ...this.data, ...local };
                // Ensure defaults
                if (!this.data.settings) this.data.settings = { selectedForNetwork: [] };
            } catch(e) { console.error(e); }
        }
    },

    // --- STANDARD APP LOGIC (Same as before) ---
    initNetwork() {
        this.network = new vis.Network(document.getElementById('mynetwork'), { nodes: this.nodes, edges: this.edges }, {
            nodes: { shape: 'box', font: { face: 'Inter', color: '#fff', size: 16 }, borderWidth: 1, color: { background: '#161b22', border: '#30363d' }, margin: 10, shadow: true },
            edges: { smooth: { type: 'continuous' } },
            physics: { forceAtlas2Based: { gravitationalConstant: -80, springLength: 150 }, solver: 'forceAtlas2Based', stabilization: { iterations: 100 } },
            interaction: { hover: true, tooltipDelay: 200 }
        });
        this.network.on("click", params => params.nodes.length && this.handleNodeClick(params.nodes[0]));
    },

    getPerson(id) { return id === 'me' ? this.data.me : this.data.people.find(p => p.id === id); },

    calculateAffinity(p1, p2) {
        let totalWeight = 0; let matchWeight = 0;
        this.data.catConfigs.forEach(conf => {
            const tags1 = p1.categories?.[conf.key] || [];
            const tags2 = p2.categories?.[conf.key] || [];
            if(tags1.length > 0 || tags2.length > 0) {
                totalWeight += (Math.max(tags1.length, tags2.length) * conf.weight);
                const matches = tags1.filter(tag => tags2.includes(tag)).length;
                matchWeight += (matches * conf.weight);
            }
        });
        return totalWeight === 0 ? 0 : Math.min(100, (matchWeight / totalWeight) * 100);
    },

    getAffinityColor(affinity, alpha = 1) {
        if(affinity >= 60) return `rgba(35, 134, 54, ${alpha})`;
        if(affinity >= 30) return `rgba(210, 153, 34, ${alpha})`;
        return `rgba(248, 81, 73, ${alpha})`; 
    },

    setMacroView(mode) {
        this.macroMode = mode; this.view = 'MACRO';
        document.getElementById('btn-radial').className = `mode-btn ${mode==='radial'?'active':''}`;
        document.getElementById('btn-mesh').className = `mode-btn ${mode==='mesh'?'active':''}`;
        this.renderMacro();
    },

    renderMacro() {
        this.view = 'MACRO'; this.activePersonId = null;
        document.getElementById('top-mode-bar').style.display = 'flex';
        document.getElementById('canvas-notes-panel').style.display = 'none';
        
        document.getElementById('sidebar-header-content').innerHTML = `
            <h2>Universo</h2>
            <div style="font-size:0.8rem; color:#8b949e; margin-top:5px;">${this.data.people.length} personas</div>
            ${!this.user ? '<div style="font-size:0.75rem; color:var(--gold); margin-top:5px;">‚ö†Ô∏è Modo Local (No sincronizado)</div>' : '<div style="font-size:0.75rem; color:var(--success); margin-top:5px;">‚òÅÔ∏è Sincronizado</div>'}
        `;

        const ui = document.getElementById('sidebar-ui');
        ui.innerHTML = `
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input id="add-name" placeholder="Nueva persona..." style="margin:0">
                <button class="btn btn-primary" onclick="App.createPerson()" style="width:40px;">+</button>
            </div>
            <button class="btn" onclick="App.enterMicro('me')" style="margin-bottom:20px;">üë§ Editar Mi ADN</button>
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn" style="font-size:0.7rem" onclick="App.selectAll(true)">Ver Todos</button>
                <button class="btn" style="font-size:0.7rem" onclick="App.selectAll(false)">Ocultar</button>
            </div>
            <div id="person-list"></div>
        `;
        this.renderPersonList();
        this.drawMacroGraph();
    },

    renderPersonList() {
        const container = document.getElementById('person-list');
        const sorted = [...this.data.people].sort((a,b) => this.calculateAffinity(this.data.me, b) - this.calculateAffinity(this.data.me, a));
        
        container.innerHTML = sorted.map(p => {
            const aff = Math.round(this.calculateAffinity(this.data.me, p));
            const isSelected = this.data.settings.selectedForNetwork.includes(p.id);
            const color = this.getAffinityColor(aff, 1);
            return `
            <div class="person-row">
                <input type="checkbox" class="person-check" ${isSelected ? 'checked' : ''} onchange="App.toggleSelection('${p.id}')">
                <div class="person-info" onclick="App.enterMicro('${p.id}')">
                    <span>${p.name}</span> <span style="font-weight:bold; color:${color}">${aff}%</span>
                </div>
            </div>`;
        }).join('');
    },

    toggleSelection(id) {
        const list = this.data.settings.selectedForNetwork;
        const idx = list.indexOf(id);
        if(idx > -1) list.splice(idx, 1); else list.push(id);
        this.saveData(); this.drawMacroGraph();
    },

    selectAll(enable) {
        this.data.settings.selectedForNetwork = enable ? this.data.people.map(p => p.id) : [];
        this.saveData(); this.renderPersonList(); this.drawMacroGraph();
    },

    drawMacroGraph() {
        this.nodes.clear(); this.edges.clear();
        this.nodes.add({ id: 'me', label: this.data.me.name, color: { background: '#fff', border: '#fff' }, font: { color: '#000', size: 18, bold: true }, shape: 'circle', size: 30 });
        const visiblePeople = this.data.people.filter(p => this.data.settings.selectedForNetwork.includes(p.id));

        visiblePeople.forEach(p => {
            this.nodes.add({ id: p.id, label: p.name, color: { background: '#161b22', border: '#58a6ff' }, shape: 'box' });
            if (this.macroMode === 'radial') {
                const aff = Math.round(this.calculateAffinity(this.data.me, p));
                const width = Math.max(1, aff / 15);
                let edgeColor = this.getAffinityColor(aff, 0.6);
                this.edges.add({ from: 'me', to: p.id, length: Math.max(80, 450 - (aff * 4)), width: width, color: { color: edgeColor }, label: aff + '%', font: { align: 'middle', size: 10, color: '#c9d1d9', background: '#090c10', strokeWidth: 0 } });
            }
        });

        if (this.macroMode === 'mesh') {
            const allNodes = [this.data.me, ...visiblePeople];
            for (let i = 0; i < allNodes.length; i++) {
                for (let j = i + 1; j < allNodes.length; j++) {
                    const aff = Math.round(this.calculateAffinity(allNodes[i], allNodes[j]));
                    if (aff > 0) { 
                        this.edges.add({ from: allNodes[i].id, to: allNodes[j].id, width: Math.max(0.5, aff / 25), color: { color: this.getAffinityColor(aff, 0.4) }, length: 300 - (aff * 2), label: aff + '%', font: { align: 'middle', size: 10, color: '#c9d1d9', background: '#090c10', strokeWidth: 0 } });
                    }
                }
            }
        }
        this.network.fit();
    },

    enterMicro(id) {
        this.view = 'MICRO'; this.activePersonId = id;
        document.getElementById('top-mode-bar').style.display = 'none';
        document.getElementById('canvas-notes-panel').style.display = 'flex';
        const p = this.getPerson(id);
        if(!p) { this.renderMacro(); return; } // Safety
        
        const isMe = (id === 'me');
        const ui = document.getElementById('sidebar-ui');
        ui.className = 'anim-fade';

        let headerHtml = isMe ? `<input type="text" value="${p.name}" onchange="App.updateName(this.value)" style="font-size:1.4rem; font-weight:bold; margin:0; background:transparent; border:1px dashed transparent; color:white;">` 
            : `<div style="display:flex; justify-content:space-between; align-items:center;"><h2 style="font-size:1.5rem">${p.name}</h2><span style="font-size:1.2rem; font-weight:bold; color:${this.getAffinityColor(Math.round(this.calculateAffinity(this.data.me, p)), 1)}">${Math.round(this.calculateAffinity(this.data.me, p))}%</span></div>`;

        document.getElementById('sidebar-header-content').innerHTML = `<button class="btn" style="width:auto; margin-bottom:10px;" onclick="App.renderMacro()">‚Üê Volver</button>${headerHtml}`;

        // AI & Content
        const aiSection = !isMe ? `<div class="ai-panel"><div style="display:flex; align-items:center; gap:5px; margin-bottom:10px; color:var(--ai-color); font-weight:bold; font-size:0.8rem;">‚ú® IA ASSISTANT</div><div style="display:flex; gap:5px; flex-wrap:wrap;"><button class="btn btn-ai" style="width:auto" onclick="App.aiSuggestTags()">üè∑Ô∏è Sugerir</button><button class="btn btn-ai" style="width:auto" onclick="App.aiProfile()">üìú Perfil</button><button class="btn btn-ai" style="width:auto" onclick="App.aiInterview()">üïµÔ∏è Pregunta</button></div><div id="ai-output" class="ai-response"></div></div>` : '';

        const accordionsHtml = this.data.catConfigs.map(conf => `
            <details ${isMe ? 'open' : ''}>
                <summary><span>${conf.label} <button class="cat-delete-btn" onclick="event.preventDefault(); App.deleteCategory('${conf.key}')">üóëÔ∏è</button></span></summary>
                <div class="details-content">
                    <div id="tag-container-${conf.key}" class="tag-container"></div>
                    <div style="margin-top:10px; display:flex; gap:5px;"><input id="new-tag-${conf.key}" placeholder="A√±adir..." style="font-size:0.8rem; padding:6px; margin:0;" onkeypress="if(event.key==='Enter') App.addTag('${conf.key}')"><button class="btn btn-primary" style="width:auto; padding:0 10px;" onclick="App.addTag('${conf.key}')">+</button></div>
                </div>
            </details>`).join('');

        const mirrorHtml = !isMe ? `<details open><summary>üîç Espejo</summary><div class="details-content" id="mirror-content"></div></details>` : '';

        ui.innerHTML = `${aiSection}${mirrorHtml}${accordionsHtml}<div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;"><div style="display:flex; gap:5px;"><input id="new-cat-name" placeholder="Nueva Categor√≠a..." style="margin:0"><button class="btn btn-primary" style="width:40px;" onclick="App.createCategory()">+</button></div></div><h3>Editor de Notas</h3><div class="editor-container"><div class="editor-toolbar"><button class="editor-btn" onclick="document.execCommand('bold',false,null)"><b>B</b></button><button class="editor-btn" onclick="document.execCommand('italic',false,null)"><i>I</i></button><button class="editor-btn" onclick="document.execCommand('insertUnorderedList',false,null)">‚Ä¢ List</button></div><div id="rich-editor" contenteditable="true" placeholder="Escribe aqu√≠..."></div></div><div style="display:flex; gap:5px; margin-bottom:20px;"><button class="btn" style="width:30px; background:#fff9c4;" onclick="App.saveNote('yellow')"></button><button class="btn" style="width:30px; background:#ffcdd2;" onclick="App.saveNote('red')"></button><button class="btn" style="width:30px; background:#c8e6c9;" onclick="App.saveNote('green')"></button><button class="btn" style="width:30px; background:#bbdefb;" onclick="App.saveNote('blue')"></button><button class="btn btn-primary" style="flex-grow:1" onclick="App.saveNote('yellow')">Fijar Nota</button></div>${!isMe ? `<button class="btn btn-danger" onclick="App.deletePerson()">Eliminar Persona</button>` : ''}`;

        this.data.catConfigs.forEach(conf => this.renderTags(conf.key, conf.cssClass));
        this.renderNotes();
        if(!isMe) this.renderMirror();
        this.drawMicroGraph();
    },

    renderTags(catKey, cssClass) {
        const container = document.getElementById(`tag-container-${catKey}`);
        if(!container) return;
        const p = this.getPerson(this.activePersonId);
        const myTags = p.categories[catKey] || [];
        const libraryOptions = this.data.library.filter(l => l.category === catKey);
        const uniqueLabels = [...new Set([...myTags, ...libraryOptions.map(l=>l.label)])].sort();

        container.innerHTML = uniqueLabels.map(label => {
            const active = myTags.includes(label);
            const isGlobal = this.data.library.some(l => l.label === label && l.category === catKey);
            let classes = `tag-item ${cssClass}`;
            if (active) classes += ' active';
            if (!isGlobal) classes += ' local';
            let promoteHtml = (!isGlobal && active) ? `<span class="promote-btn" onclick="event.stopPropagation(); App.promoteTag('${catKey}', '${label}')">‚Üë</span>` : '';
            return `<div class="${classes}" onclick="App.toggleTag('${catKey}', '${label}')">${label} ${promoteHtml} <div class="tag-del-btn" onclick="event.stopPropagation(); App.deleteConcept('${catKey}', '${label}')">üóëÔ∏è</div></div>`;
        }).join('');
    },

    renderMirror() {
        const container = document.getElementById('mirror-content');
        const me = this.data.me; const p = this.getPerson(this.activePersonId);
        let html = '';
        this.data.catConfigs.forEach(conf => {
            const myTags = me.categories[conf.key] || [];
            const theirTags = p.categories[conf.key] || [];
            const shared = myTags.filter(t => theirTags.includes(t));
            const diffThem = theirTags.filter(t => !myTags.includes(t));
            if(shared.length > 0 || diffThem.length > 0) {
                html += `<div style="font-size:0.7rem; text-transform:uppercase; color:#666; margin-top:8px;">${conf.label}</div>`;
                shared.forEach(t => html += `<div class="comp-row"><div class="comp-col shared"><span class="circle-dot circle-green"></span>${t}</div><div class="comp-col"></div></div>`);
                diffThem.forEach(t => html += `<div class="comp-row"><div class="comp-col"></div><div class="comp-col diff"><span class="circle-dot circle-red"></span>${t}</div></div>`);
            }
        });
        container.innerHTML = html || '<div style="font-style:italic; color:#555;">No hay datos relevantes.</div>';
    },

    saveNote(color) {
        const content = document.getElementById('rich-editor').innerHTML;
        if(!content || content === '<br>') return;
        const p = this.getPerson(this.activePersonId);
        p.notes.push({ id: Date.now(), html: content, color, date: new Date().toLocaleDateString() });
        this.saveData(); this.renderNotes();
        document.getElementById('rich-editor').innerHTML = '';
    },

    renderNotes() {
        const panel = document.getElementById('canvas-notes-panel');
        const p = this.getPerson(this.activePersonId);
        const notes = (p.notes || []).sort((a,b) => b.id - a.id);
        if (notes.length === 0) { panel.innerHTML = ''; return; }
        panel.innerHTML = notes.map(n => `<div class="note-card ${n.color}"><span class="note-date">${n.date}</span><div class="note-content" contenteditable="true" onblur="App.updateNoteContent(${n.id}, this.innerHTML)">${n.html || n.text}</div><div class="note-actions"><button class="mini-btn" title="Eliminar nota" onclick="App.deleteNote(${n.id})">‚úï</button></div></div>`).join('');
    },

    updateNoteContent(id, newHtml) {
        const p = this.getPerson(this.activePersonId);
        const note = p.notes.find(n => n.id === id);
        if(note) { note.html = newHtml; this.saveData(); }
    },

    deleteNote(id) {
        if(!confirm('¬øBorrar nota?')) return;
        const p = this.getPerson(this.activePersonId);
        p.notes = p.notes.filter(x => x.id !== id);
        this.saveData(); this.renderNotes();
    },

    // --- ACTIONS ---
    toggleTag(catKey, label) {
        const p = this.getPerson(this.activePersonId);
        const idx = p.categories[catKey].indexOf(label);
        if (idx >= 0) p.categories[catKey].splice(idx, 1); else p.categories[catKey].push(label);
        if (this.activePersonId === 'me' && !this.data.library.find(l => l.label === label && l.category === catKey)) {
            this.data.library.push({ id: 'l_'+Date.now(), label, category: catKey });
        }
        this.saveData();
        this.renderTags(catKey, this.data.catConfigs.find(c=>c.key===catKey).cssClass);
        if(this.activePersonId !== 'me') this.renderMirror();
        this.drawMicroGraph();
    },

    addTag(catKey) {
        const val = document.getElementById(`new-tag-${catKey}`).value.trim();
        if(val) { this.toggleTag(catKey, val); document.getElementById(`new-tag-${catKey}`).value=''; }
    },

    promoteTag(catKey, label) {
        if (!this.data.library.find(l => l.label === label && l.category === catKey)) {
            this.data.library.push({ id: 'l_'+Date.now(), label, category: catKey });
            this.saveData(); this.enterMicro(this.activePersonId);
        }
    },

    deleteConcept(catKey, label) {
        if(!confirm(`¬øEliminar "${label}" permanentemente?`)) return;
        this.data.library = this.data.library.filter(l => !(l.label === label && l.category === catKey));
        const cleanPerson = (p) => { if(p.categories[catKey]) p.categories[catKey] = p.categories[catKey].filter(t => t !== label); };
        cleanPerson(this.data.me); this.data.people.forEach(cleanPerson);
        this.saveData(); this.enterMicro(this.activePersonId);
    },

    createCategory() {
        const name = document.getElementById('new-cat-name').value.trim();
        if(!name) return;
        const key = 'cat_' + Date.now();
        this.data.catConfigs.push({ key: key, label: 'üìÇ ' + name, weight: 1.0, color: '#8b949e', cssClass: 'cat-extras' });
        const initCat = (p) => { if(!p.categories[key]) p.categories[key] = []; };
        initCat(this.data.me); this.data.people.forEach(initCat);
        this.saveData(); this.enterMicro(this.activePersonId);
    },

    deleteCategory(key) {
        if(!confirm('¬øBorrar categor√≠a?')) return;
        this.data.catConfigs = this.data.catConfigs.filter(c => c.key !== key);
        this.saveData(); this.enterMicro(this.activePersonId);
    },

    createPerson() {
        const name = document.getElementById('add-name').value.trim();
        if(!name) return alert('Escribe un nombre');
        const newPerson = { id: 'p_' + Date.now(), name: name, categories: {}, notes: [] };
        this.data.catConfigs.forEach(c => newPerson.categories[c.key] = []);
        this.data.people.push(newPerson);
        this.data.settings.selectedForNetwork.push(newPerson.id);
        document.getElementById('add-name').value = '';
        this.saveData();
        this.renderMacro();
    },

    deletePerson() {
        if(!confirm('¬øEliminar persona?')) return;
        this.data.people = this.data.people.filter(p => p.id !== this.activePersonId);
        this.saveData(); this.renderMacro();
    },

    updateName(val) { if(val) { this.getPerson(this.activePersonId).name = val; this.saveData(); } },
    toggleSidebar() { document.getElementById('sidebar-container').classList.toggle('collapsed'); },
    handleNodeClick(id) { if (id === 'me' || this.data.people.find(p => p.id === id)) this.enterMicro(id); },
    
    drawMicroGraph() {
        const p = this.getPerson(this.activePersonId);
        this.nodes.clear(); this.edges.clear();
        this.nodes.add({ id: 'center', label: p.name, shape: 'box', color: {background:'#fff', border:'#fff'}, font:{size:20, color:'#000'}, fixed:true });
        let i = 0;
        this.data.catConfigs.forEach(conf => {
            if(p.categories[conf.key]) {
                p.categories[conf.key].forEach(label => {
                    i++;
                    this.nodes.add({ id: 'n_'+i, label: label, shape: 'ellipse', color: { background: '#0d1117', border: conf.color }, font: { color: conf.color } });
                    this.edges.add({ from: 'center', to: 'n_'+i, color: '#333' });
                });
            }
        });
        this.network.fit();
    },

    // --- IA ---
    openSettings() { document.getElementById('settings-modal').style.display = 'flex'; },
    saveSettings() {
        this.data.apiKey = document.getElementById('api-key-input').value;
        this.saveData(); document.getElementById('settings-modal').style.display = 'none';
        if(this.view === 'MICRO') this.enterMicro(this.activePersonId);
    },
    async callAI(sys, user) {
        if(!this.data.apiKey) return alert("Configura tu API Key primero en ‚öôÔ∏è");
        const out = document.getElementById('ai-output');
        out.style.display = 'block'; out.innerText = "Pensando..."; out.classList.add('loading-dots');
        try {
            const req = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST', headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${this.data.apiKey}`},
                body: JSON.stringify({ model: "gpt-4o-mini", messages: [{role:"system",content:sys},{role:"user",content:user}] })
            });
            const res = await req.json();
            out.classList.remove('loading-dots');
            if(res.error) return out.innerText = "Error: " + res.error.message;
            return res.choices[0].message.content;
        } catch(e) { out.innerText = "Error conexi√≥n"; }
    },
    async aiSuggestTags() {
        const p = this.getPerson(this.activePersonId);
        const res = await this.callAI("Eres experto en psicolog√≠a. Da 5 etiquetas cortas (valores/rasgos) separadas por comas.", `Perfil: ${JSON.stringify(p.categories)}`);
        if(res) document.getElementById('ai-output').innerText = "Sugerencias: " + res;
    },
    async aiProfile() {
        const p = this.getPerson(this.activePersonId);
        const res = await this.callAI("Crea un perfil psicol√≥gico breve (max 50 palabras) en 2da persona.", `Datos: ${JSON.stringify(p.categories)}`);
        if(res) document.getElementById('ai-output').innerText = res;
    },
    async aiInterview() {
        const p = this.getPerson(this.activePersonId);
        const res = await this.callAI("Genera una pregunta profunda para conectar con esta persona.", `Intereses: ${JSON.stringify(p.categories)}`);
        if(res) document.getElementById('ai-output').innerHTML = `<em>"${res}"</em> <button class="btn btn-primary" onclick="App.saveAiResponse('${res.replace(/'/g,"")}')" style="margin-top:5px; font-size:0.7rem">Guardar</button>`;
    },
    saveAiResponse(q) {
        const p = this.getPerson(this.activePersonId);
        p.notes.push({ id: Date.now(), html: `<b>IA Pregunta:</b> ${q}<br>R:`, color: 'yellow', date: new Date().toLocaleDateString() });
        this.saveData(); this.renderNotes();
    }
};

window.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>

